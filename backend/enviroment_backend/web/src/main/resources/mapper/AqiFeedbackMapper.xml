<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.peels.mapper.AqiFeedbackMapper">

    <resultMap type="com.peels.entity.AqiFeedback" id="aqiFeedbackResultMap">
        <id property="afId" column="af_id" />
        <result property="telId" column="tel_id" />
        <result property="provinceId" column="province_id" />
        <result property="cityId" column="city_id" />
        <result property="address" column="address" />
        <result property="information" column="information" />
        <result property="estimatedGrade" column="estimated_grade" />
        <result property="afDate" column="af_date" />
        <result property="afTime" column="af_time" />
        <result property="gmId" column="gm_id" />
        <result property="assignDate" column="assign_date" />
        <result property="assignTime" column="assign_time" />
        <result property="state" column="state" />
        <result property="remarks" column="remarks" />

        <association property="supervisor" javaType="com.peels.entity.Supervisor">
            <id property="telId" column="su_tel_id" />
            <result property="realName" column="su_real_name" />
            <result property="birthday" column="su_birthday" />
            <result property="sex" column="su_sex" />
        </association>

        <association property="gridProvince"
                     javaType="com.peels.entity.GridProvince">
            <id property="provinceId" column="gp_province_id" />
            <result property="provinceName" column="gp_province_name" />
            <result property="provinceAbbr" column="gp_province_abbr" />
        </association>
        <association property="gridCity" javaType="com.peels.entity.GridCity">
            <id property="cityId" column="gc_city_id" />
            <result property="cityName" column="gc_city_name" />
        </association>
        <association property="aqi" javaType="com.peels.entity.Aqi">
            <id property="aqiId" column="aq_aqi_id" />
            <result property="chineseExplain" column="aq_chinese_explain" />
            <result property="color" column="aq_color" />
            <result property="aqiExplain" column="aq_aqi_explain" />
        </association>
        <association property="gridMember" javaType="com.peels.entity.GridMember">
            <id property="gmId" column="gm_gm_id" />
            <result property="gmName" column="gm_gm_name" />
            <result property="tel" column="gm_tel" />
        </association>
    </resultMap>

    <sql id="aqiFeedbackSqlSelect">
        select af.*,
               gm.gm_id gm_gm_id,
               gm.gm_name gm_gm_name,
               gm.tel gm_tel,
               su.tel_id su_tel_id,
               su.real_name su_real_name,
               su.birthday su_birthday,
               su.sex su_sex,
               gp.province_id gp_province_id,
               gp.province_name gp_province_name,
               gp.province_abbr gp_province_abbr,
               gc.city_id gc_city_id,
               gc.city_name gc_city_name,
               aq.aqi_id aq_aqi_id,
               aq.chinese_explain aq_chinese_explain,
               aq.color aq_color,
               aq.aqi_explain aq_aqi_explain
        from (aqi_feedback af left join grid_member gm on af.gm_id=gm.gm_id)
                 join supervisor su on af.tel_id=su.tel_id
                 join grid_province gp on af.province_id=gp.province_id
                 join grid_city gc on af.city_id=gc.city_id
                 join aqi aq on af.estimated_grade=aq.aqi_id
    </sql>

    <sql id="aqiFeedbackSqlWhere">
        <where>
            af.state = #{state}
            <if test="provinceId!=0">
                and af.province_id = #{provinceId}
            </if>
            <if test="cityId!=0">
                and af.city_id = #{cityId}
            </if>
            <if test="estimatedGrade!=0">
                and af.estimated_grade = #{estimatedGrade}
            </if>
            <if test="afDate!=null and afDate!=''">
                and af.af_date = #{afDate}
            </if>
        </where>
    </sql>

    <!-- neps工程 -->
    <select id="listAqiFeedbackByTelId" parameterType="String"
            resultMap="aqiFeedbackResultMap">
        <include refid="aqiFeedbackSqlSelect"></include>
        where af.tel_id = #{telId}
        order by af.af_date desc,af.af_time desc
    </select>
    <!-- neps工程 -->

    <!-- nepm工程 -->
    <select id="getAqiFeedbackCount" parameterType="AfPageRequestDto" resultType="int">
        select count(*)
        from aqi_feedback af
        <include refid="aqiFeedbackSqlWhere"></include>
    </select>

    <select id="listAqiFeedbackPage" parameterType="AfPageRequestDto" resultMap="aqiFeedbackResultMap">
        <include refid="aqiFeedbackSqlSelect"></include>
        <include refid="aqiFeedbackSqlWhere"></include>
        order by af.af_id desc
        limit #{beginNum},#{maxPageNum}
    </select>

    <select id="getAqiFeedbackById" parameterType="int" resultMap="aqiFeedbackResultMap">
        <include refid="aqiFeedbackSqlSelect"></include>
        where af.af_id=#{afId}
    </select>

    <!-- nepm工程 -->

    <!-- nepg工程 -->
    <select id="listAqiFeedbackByGmId" parameterType="AqiFeedback" resultMap="aqiFeedbackResultMap">
        <include refid="aqiFeedbackSqlSelect"></include>
        where af.gm_id=#{gmId} and af.state=#{state}
        order by af.af_date,af.af_time
    </select>

</mapper>
